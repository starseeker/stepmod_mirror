SCHEMA Generic_expression_arm;

USE FROM Numeric_expression_arm;
USE FROM Boolean_expression_arm;
USE FROM String_expression_arm;

ENTITY Generic_expression


ABSTRACT SUPERTYPE OF(ONEOF(Simple_generic_expression,
			    Unary_generic_expression,
			    Binary_generic_expression,
			    Multiple_arity_generic_expression));
WHERE 
	WR1: Is_Acyclic(SELF);
END_ENTITY;

ENTITY Simple_generic_expression
ABSTRACT SUPERTYPE OF (ONEOF(Generic_literal, Generic_variable))
SUBTYPE OF (Generic_expression);
END_ENTITY;

ENTITY Generic_literal
ABSTRACT SUPERTYPE
SUBTYPE OF (Simple_generic_expression);
END_ENTITY; 

ENTITY Generic_variable
ABSTRACT SUPERTYPE
SUBTYPE OF (Simple_generic_expression);
INVERSE
	interpretation : Environment FOR syntactic_representation;
END_ENTITY;

ENTITY Variable_semantics
ABSTRACT SUPERTYPE;
END_ENTITY;

ENTITY Environment;
	syntactic_representation: Generic_variable;
	semantics: Variable_semantics;
END_ENTITY;

ENTITY Unary_generic_expression
ABSTRACT SUPERTYPE
SUBTYPE OF(Generic_expression);
	operand: Generic_expression;
END_ENTITY;

ENTITY Binary_generic_expression
ABSTRACT SUPERTYPE
SUBTYPE OF(Generic_expression);
	operands: LIST [2:2] OF Generic_expression;
END_ENTITY;

ENTITY Multiple_arity_generic_expression
ABSTRACT SUPERTYPE
SUBTYPE OF(Generic_expression);
	operands: LIST [2:?] OF Generic_expression;
END_ENTITY;

ENTITY Variable
ABSTRACT SUPERTYPE OF (ONEOF (Numeric_variable,
				Boolean_variable,
					String_variable))
SUBTYPE OF(Generic_variable);
END_ENTITY;

ENTITY Numeric_variable
SUPERTYPE OF (ONEOF (Int_numeric_variable,
			          Real_numeric_variable))
SUBTYPE OF (Simple_numeric_expression, Variable);
WHERE 
	WR1:	('ISO13584_EXPRESSIONS_SCHEMA.Int_numeric_variable' 
			IN TYPEOF(SELF) ) OR
			('ISO13584_EXPRESSIONS_SCHEMA.Real_numeric_variable' 
			IN TYPEOF(SELF) );
END_ENTITY;

ENTITY Int_numeric_variable
SUBTYPE OF (Numeric_variable);
END_ENTITY;

ENTITY Real_numeric_variable
SUBTYPE OF (Numeric_variable);
END_ENTITY;

ENTITY Boolean_variable
SUBTYPE OF (Simple_Boolean_expression, Variable);
END_ENTITY;

ENTITY String_variable
SUBTYPE OF (Simple_string_expression, Variable);
END_ENTITY;

(*
FUNCTION Is_Acyclic (arg: Generic_expression): BOOLEAN;
RETURN (Acyclic (arg, []));
END_FUNCTION ; -- Is_Acyclic

FUNCTION Acyclic (arg1: Generic_expression; 
			arg2: SET OF Generic_expression): BOOLEAN;

LOCAL
	result: BOOLEAN;
END_LOCAL;

IF ('ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Simple_generic_expression'
	IN TYPEOF (arg1)) 
THEN
	RETURN (TRUE);
END_IF;

IF arg1 IN arg2 
THEN 
	RETURN (FALSE);
END_IF;

IF 'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Unary_generic_expression' 
	IN TYPEOF (arg1) 
THEN 
	RETURN 
	(Acyclic(arg1\Unary_generic_expression.operand,arg2+[arg1]));
END_IF;

IF 'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Binary_generic_expression' 
	IN TYPEOF (arg1) 
THEN 
	RETURN 
	(Acyclic(arg1\Binary_generic_expression.operands[1],arg2+[arg1])
	AND
	Acyclic(arg1\Binary_generic_expression.operands[2],arg2+[arg1]));
END_IF;

IF 
'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Multiple_arity_generic_expression' 
	IN TYPEOF (arg1) 
THEN 
	result := TRUE;
	REPEAT i := 1 TO 
			SIZEOF (arg1\Multiple_arity_generic_expression.operands);
		result := result AND
		Acyclic(arg1\Multiple_arity_generic_expression.operands[i], arg2+[arg1]);
	END_REPEAT;

	RETURN (result);
END_IF;

END_FUNCTION; -- Acyclic

FUNCTION Used_variables (arg : Generic_expression) : 
			SET OF Generic_variable;

LOCAL
	result : SET OF Generic_variable := [];
END_LOCAL;

IF 'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Generic_variable' 
	IN TYPEOF (arg) 
THEN 
	RETURN ([arg]);
END_IF;

IF 'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Unary_generic_expression' 
	IN TYPEOF (arg)
THEN 
	RETURN (Used_variables (arg\Unary_generic_expression.operand));
END_IF;

IF 'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Binary_generic_expression'
	IN TYPEOF (arg)
THEN 
	RETURN(Used_variables(arg\Binary_generic_expression.operands[1])
		+ Used_variables (arg\Binary_generic_expression.operands[2]));
END_IF;

IF
'ISO13584_GENERIC_EXPRESSIONS_SCHEMA.Multiple_arity_generic_expression' 
	IN TYPEOF (arg)
THEN
	REPEAT i := 1 TO 
		SIZEOF(arg\Multiple_arity_generic_expression.operands);
		result := result + Used_variables(
			arg\Multiple_arity_generic_expression.operands[i]);
	END_REPEAT;
	
	RETURN (result);
END_IF;
RETURN ([ ]);      -- in this case the subtype shall not contain
			            -- any Variable (see IP1 in Generic_expression)
END_FUNCTION; -- Used_variables


*)
END_SCHEMA;
