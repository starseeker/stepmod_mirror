<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<?xml-stylesheet type="text/xsl" href="../../../xsl/express.xsl"?>
<!DOCTYPE express SYSTEM "../../../dtd/express.dtd">

<express description.file="mim_descriptions.xml" language_version="2" rcs.date="$Date: 2017/06/23 07:49:55 $" rcs.revision="$Revision: 1.35 $" reference="ISO/TS 10303-1051">
   <application name="JSDAI" owner="LKSoft" source="geometric_tolerance_mim schema_instance" url="www.lksoft.com" version="4.0 beta"/>
   <schema name="Geometric_tolerance_mim">
      <interface kind="use" schema="Derived_shape_element_mim"/>
      <interface kind="use" schema="Measure_representation_mim"/>
      <interface kind="use" schema="Value_with_unit_extension_mim"/>
      <interface kind="use" schema="Support_resource_mim"/>
      <interface kind="use" schema="Shape_composition_mim"/>
      <interface kind="use" schema="Dimension_tolerance_mim"/>
      <interface kind="use" schema="Feature_and_connection_zone_mim"/>
      <interface kind="use" schema="shape_aspect_definition_schema">
         <interfaced.item name="all_around_shape_aspect"/>
         <interfaced.item name="apex"/>
         <interfaced.item name="between_shape_aspect"/>
         <interfaced.item name="centre_of_symmetry"/>
         <interfaced.item name="continuous_shape_aspect"/>
         <interfaced.item name="composite_shape_aspect"/>
         <interfaced.item name="composite_group_shape_aspect"/>
         <interfaced.item name="common_datum"/>
         <interfaced.item name="common_datum_list"/>
         <interfaced.item name="contacting_feature"/>
         <interfaced.item name="datum"/>
         <interfaced.item name="datum_feature"/>
         <interfaced.item name="datum_reference_modifier_with_value"/>
         <interfaced.item name="datum_reference"/>
         <interfaced.item name="datum_reference_compartment"/>
         <interfaced.item name="datum_reference_element"/>
         <interfaced.item name="datum_system"/>
         <interfaced.item name="datum_target"/>
         <interfaced.item name="derived_shape_aspect"/>
         <interfaced.item name="extension"/>
         <interfaced.item name="general_datum_reference"/>
         <interfaced.item name="geometric_alignment"/>
         <interfaced.item name="geometric_contact"/>
         <interfaced.item name="geometric_intersection"/>
         <interfaced.item name="parallel_offset"/>
         <interfaced.item name="perpendicular_to"/>
         <interfaced.item name="referenced_modified_datum"/>
         <interfaced.item name="simple_datum_reference_modifier"/>
         <interfaced.item name="shape_aspect_deriving_relationship"/>
         <interfaced.item name="symmetric_shape_aspect"/>
         <interfaced.item name="tangent"/>
      </interface>
      <interface kind="use" schema="shape_tolerance_schema">
         <interfaced.item name="dimension_related_tolerance_zone_element"/>
         <interfaced.item name="geometric_tolerance"/>
         <interfaced.item name="geometric_tolerance_relationship"/>
         <interfaced.item name="geometric_tolerance_with_datum_reference"/>
         <interfaced.item name="geometric_tolerance_with_defined_unit"/>
         <interfaced.item name="geometric_tolerance_with_defined_area_unit"/>
         <interfaced.item name="geometric_tolerance_with_maximum_tolerance"/>
         <interfaced.item name="geometric_tolerance_with_modifiers"/>
         <interfaced.item name="modified_geometric_tolerance"/>
         <interfaced.item name="non_uniform_zone_definition"/>
         <interfaced.item name="projected_zone_definition"/>
         <interfaced.item name="projected_zone_definition_with_offset"/>
         <interfaced.item name="runout_zone_definition"/>
         <interfaced.item name="runout_zone_orientation_reference_direction"/>
         <interfaced.item name="tolerance_zone"/>
         <interfaced.item name="tolerance_zone_definition"/>
         <interfaced.item name="tolerance_zone_form"/>
         <interfaced.item name="cylindricity_tolerance"/>
         <interfaced.item name="flatness_tolerance"/>
         <interfaced.item name="line_profile_tolerance"/>
         <interfaced.item name="position_tolerance"/>
         <interfaced.item name="roundness_tolerance"/>
         <interfaced.item name="straightness_tolerance"/>
         <interfaced.item name="surface_profile_tolerance"/>
         <interfaced.item name="angularity_tolerance"/>
         <interfaced.item name="circular_runout_tolerance"/>
         <interfaced.item name="coaxiality_tolerance"/>
         <interfaced.item name="concentricity_tolerance"/>
         <interfaced.item name="parallelism_tolerance"/>
         <interfaced.item name="perpendicularity_tolerance"/>
         <interfaced.item name="symmetry_tolerance"/>
         <interfaced.item name="total_runout_tolerance"/>
         <interfaced.item name="unequally_disposed_geometric_tolerance"/>
      </interface>
      <interface kind="use" schema="product_property_definition_schema">
         <interfaced.item name="property_definition"/>
      </interface>
      <interface kind="use" schema="product_property_representation_schema">
         <interfaced.item name="property_definition_representation"/>
         <interfaced.item name="shape_representation"/>
      </interface>
      <interface kind="reference" schema="support_resource_schema">
         <interfaced.item name="bag_to_set"/>
         <interfaced.item name="type_check_function"/>
      </interface>
      <entity name="feature_for_datum_target_relationship" supertypes="shape_aspect_relationship">
         <explicit name="related_shape_aspect">
            <typename name="datum_target"/>
            <redeclaration entity-ref="shape_aspect_relationship"/>
         </explicit>
         <unique label="UR1">
            <unique.attribute attribute="related_shape_aspect"/>
         </unique>
         <where expression="relating_shape_aspect.of_shape :=: related_shape_aspect.of_shape" label="WR1"/>
         <where expression="relating_shape_aspect\shape_aspect.product_definitional = TRUE" label="WR2"/>
      </entity>
      <entity name="placed_datum_target_feature" supertypes="datum_target">
         <derived expression="get_shape_aspect_property_definition_representations(SELF)" name="representation_associations">
            <aggregate lower="0" type="SET" upper="?"/>
            <typename name="property_definition_representation"/>
         </derived>
         <where expression="SELF.description IN ['point','line','rectangle','circle','circular curve']" label="WR1"/>
         <where expression="SIZEOF (QUERY (pdr &lt;* representation_associations | 'GEOMETRIC_TOLERANCE_MIM.SHAPE_REPRESENTATION_WITH_PARAMETERS' IN TYPEOF (pdr.used_representation) )) = 1" label="WR2"/>
         <where expression="valid_datum_target_parameters(SELF)" label="WR3"/>
      </entity>
      <rule
        name="non_uniform_zone_definition_constraint"
        appliesto="tolerance_zone_definition tolerance_zone tolerance_zone_form">
        <algorithm>
			LOCAL
			tzf_set : SET OF tolerance_zone_form := QUERY(tzf &lt;* tolerance_zone_form | tzf\tolerance_zone_form.name = 'non uniform');
			nuzd_set : SET OF tolerance_zone_definition := QUERY(tzd &lt;* tolerance_zone_definition | 'SHAPE_TOLERANCE_SCHEMA.NON_UNIFORM_ZONE_DEFINITION' IN TYPEOF(tzd));
			END_LOCAL;
        </algorithm>
        <where
          label="WR1"
          expression="QUERY(tzd &lt;* nuzd_set |(tzd\tolerance_zone_definition.zone\tolerance_zone.form IN tzf_set)) = nuzd_set">
        </where>
      </rule>      
      <rule appliesto="tolerance_zone_form" name="tolerance_zone_form_name_constraint">
         <algorithm>LOCAL
 names : SET OF STRING :=
  [ 'within a circle',
    'between two concentric circles',
    'between two equidistant curves',
    'within a cylinder',
    'between two coaxial cylinders',
    'between two equidistant surfaces',
    'non uniform',
    'cylindrical or circular',
    'spherical',
    'unknown'];
 pass : BOOLEAN := TRUE;
END_LOCAL;
REPEAT i := 1 to SIZEOF(tolerance_zone_form) WHILE pass;
 pass := (tolerance_zone_form[i].name IN names);
END_REPEAT;</algorithm>
         <where expression="pass" label="WR1"/>
      </rule>
      <rule appliesto="product_definition_shape dimensional_location dimensional_size shape_aspect shape_aspect_relationship" name="unique_gdt_element_id_constraint">
         <algorithm>LOCAL
 bss  : BAG OF STRING := [];
 ds   : SET OF dimensional_size := QUERY(ds &lt;* dimensional_size | EXISTS(ds\dimensional_size.id));
 sa   : SET OF shape_aspect := QUERY(sa &lt;* shape_aspect | EXISTS(sa\shape_aspect.id));
 sar  : SET OF shape_aspect_relationship := QUERY(sar &lt;* shape_aspect_relationship | EXISTS(sar\shape_aspect_relationship.id));
 ssa  : SET OF shape_aspect := []; 
 pass : BOOLEAN := TRUE;
END_LOCAL;
REPEAT ii := 1 TO SIZEOF (product_definition_shape) WHILE pass;
 bss := [];
 ssa := bag_to_set(USEDIN(product_definition_shape[ii], 'PRODUCT_PROPERTY_DEFINITION_SCHEMA.' + 'SHAPE_ASPECT.' + 'OF_SHAPE'));

 REPEAT i := 1 to SIZEOF (ds);
  IF (ds[i]\dimensional_size.applies_to IN ssa) THEN
   bss := bss + ds[i]\dimensional_size.id;
  END_IF;
 END_REPEAT;

 REPEAT i := 1 to SIZEOF (sa);
  IF (sa[i] IN ssa) THEN
   bss := bss + sa[i]\shape_aspect.id;
  END_IF;
 END_REPEAT;

 REPEAT i := 1 to SIZEOF (sar);
  IF (sar[i]\shape_aspect_relationship.relating_shape_aspect IN ssa) THEN
   bss := bss + sar[i]\shape_aspect_relationship.id;
  END_IF;
 END_REPEAT;

 IF (SIZEOF(bag_to_set(bss)) &lt;&gt; SIZEOF(bss)) THEN pass := FALSE;
 END_IF;
END_REPEAT;</algorithm>
         <where expression="pass" label="WR1"/>
      </rule>
      <function name="get_shape_aspect_property_definition_representations">
         <parameter name="s_a_instance">
            <typename name="shape_aspect"/>
         </parameter>
         <aggregate lower="0" type="SET" upper="?"/>
         <typename name="property_definition_representation"/>
         <algorithm>LOCAL
pd_set : SET OF property_definition := [];
pdr_set : SET OF property_definition_representation := [] ;
END_LOCAL;
pd_set := bag_to_set(USEDIN(s_a_instance, 'PRODUCT_PROPERTY_DEFINITION_SCHEMA.PROPERTY_DEFINITION.DEFINITION'));
IF (SIZEOF(pd_set) &lt; 1) THEN
RETURN (pdr_set);
END_IF;
REPEAT i := 1 TO HIINDEX(pd_set);
pdr_set := pdr_set + (QUERY(pdr &lt;* USEDIN(pd_set[i], 'PRODUCT_PROPERTY_REPRESENTATION_SCHEMA.' + 'PROPERTY_DEFINITION_REPRESENTATION.' + 'DEFINITION') |
'PRODUCT_PROPERTY_REPRESENTATION_SCHEMA.SHAPE_DEFINITION_REPRESENTATION' IN TYPEOF(pdr)));
END_REPEAT;
RETURN (pdr_set);</algorithm>
      </function>
      <function name="valid_datum_target_parameters">
         <parameter name="pdf">
            <typename name="placed_datum_target_feature"/>
         </parameter>
         <builtintype type="BOOLEAN"/>
         <algorithm>LOCAL
    rep_set : SET OF representation := [] ;
    parameter_representations: SET OF representation;
  END_LOCAL;

  REPEAT i := 1 TO HIINDEX(pdf.representation_associations);
    rep_set := rep_set + pdf.representation_associations[i].used_representation;
  END_REPEAT;
  parameter_representations := QUERY(rep &lt;* rep_set | ('GEOMETRIC_TOLERANCE_MIM.SHAPE_REPRESENTATION_WITH_PARAMETERS' IN TYPEOF(rep)));

  IF (SIZEOF( QUERY( srwp &lt;* parameter_representations |
          (SIZEOF( QUERY( i &lt;* srwp.items |
          (i.name='orientation') AND
          ('GEOMETRY_SCHEMA.PLACEMENT' IN TYPEOF(i)))) = 1))) &lt;&gt; 1) THEN
    RETURN(FALSE);
  END_IF;
  CASE pdf\shape_aspect.description OF
    'point': RETURN(SIZEOF(QUERY( srwp &lt;* parameter_representations |
              (SIZEOF(srwp.items) = 1))) = 1);
    'circle', 'circular curve': RETURN((SIZEOF( QUERY( srwp &lt;* parameter_representations |
              (SIZEOF(srwp.items) = 2))) = 1) AND
             (SIZEOF( QUERY( srwp &lt;* parameter_representations |
              (SIZEOF( QUERY( i &lt;* srwp.items |
                (i.name='target diameter') AND
                (SIZEOF(['GEOMETRIC_TOLERANCE_MIM.MEASURE_REPRESENTATION_ITEM',
		   'GEOMETRIC_TOLERANCE_MIM.LENGTH_MEASURE_WITH_UNIT']*TYPEOF(i)
                 ) = 2) )) = 1))) = 1));
    'line': RETURN(SIZEOF( QUERY( srwp &lt;* parameter_representations |
              (SIZEOF( QUERY( i &lt;* srwp.items |
                (i.name='target length') AND
                (SIZEOF(['GEOMETRIC_TOLERANCE_MIM.MEASURE_REPRESENTATION_ITEM',
		'GEOMETRIC_TOLERANCE_MIM.LENGTH_MEASURE_WITH_UNIT']*TYPEOF(i)
                 ) = 2) )) = 1))) = 1);
    'rectangle': RETURN((SIZEOF( QUERY( srwp &lt;* parameter_representations |
              (SIZEOF(srwp.items)= 3))) = 1) AND
             (SIZEOF( QUERY( srwp &lt;* parameter_representations |
              (SIZEOF( QUERY( i &lt;* srwp.items |
                (i.name='target length') AND
                (SIZEOF(['GEOMETRIC_TOLERANCE_MIM.MEASURE_REPRESENTATION_ITEM',
		'GEOMETRIC_TOLERANCE_MIM.LENGTH_MEASURE_WITH_UNIT']*TYPEOF(i)
                 ) = 2))) = 1))) = 1) AND
              (SIZEOF( QUERY( srwp &lt;* parameter_representations |
               (SIZEOF( QUERY( i &lt;* srwp.items |
                 (i.name='target width') AND
                 (SIZEOF(['GEOMETRIC_TOLERANCE_MIM.MEASURE_REPRESENTATION_ITEM',
 		'GEOMETRIC_TOLERANCE_MIM.LENGTH_MEASURE_WITH_UNIT']*TYPEOF(i)
                  ) = 2))) = 1) )) = 1));
    OTHERWISE : RETURN(FALSE);
  END_CASE;</algorithm>
      </function>
   </schema>
</express>
