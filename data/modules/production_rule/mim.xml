<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../../../xsl/express.xsl"?>
<!DOCTYPE express SYSTEM "../../../dtd/express.dtd">

<express language_version="2" rcs.date="2005-10-26T15:28:21" rcs.revision="1.0" description.file="mim_descriptions.xml">
<application name="JSDAI" owner="LKSoft" url="www.lksoft.com" version="4.0 beta" source="production_rule_mim schema_instance"/>
<schema name="Production_rule_mim">
<interface kind="use" schema="Model_parameter_mim"/>
<interface kind="use" schema="Specification_document_mim"/>
<interface kind="use" schema="Software_mim"/>
<interface kind="use" schema="Product_identification_mim"/>
<interface kind="use" schema="Date_time_assignment_mim"/>
<interface kind="use" schema="Activity_mim"/>
<interface kind="use" schema="product_definition_schema">
<interfaced.item name="product_definition_relationship"/>
</interface>
<type name="pr_action_items">
<select extensible="YES" genericentity="YES" basedon="action_items" selectitems="product_definition_formation"/>
</type>
<type name="pr_date_and_time_item">
<select extensible="YES" genericentity="YES" basedon="date_and_time_item" selectitems="rule_action"/>
</type>
<type name="pr_document_reference_item">
<select extensible="YES" genericentity="YES" basedon="document_reference_item" selectitems="rule_function_definition representation"/>
</type>
<type name="pr_name_item">
<select extensible="YES" genericentity="YES" basedon="name_item" selectitems="rule_set"/>
</type>
<type name="rule_superseded_item">
<select selectitems="product_definition_formation"/>
</type>
<entity name="rule_action" supertypes="action">
<where label="WR1" expression="SIZEOF (QUERY (aaa &lt;* QUERY (aa &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' + &#10;       'ACTION_ASSIGNMENT.ASSIGNED_ACTION') |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'APPLIED_ACTION_ASSIGNMENT' IN&#10;       TYPEOF (aa)) |&#10;       SIZEOF (QUERY (it &lt;* aaa.items |&#10;       (('PRODUCTION_RULE_MIM.' +&#10;       'PRODUCT_DEFINITION_FORMATION' IN &#10;       TYPEOF (it))&#10;AND (it\product_definition_formation.description = 'rule version'))&#10;)) = 1)) = 1"/>
<where label="WR2" expression="SIZEOF (QUERY (adta &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'APPLIED_DATE_AND_TIME_ASSIGNMENT.ITEMS') |&#10;       adta.role\date_time_role.name = 'participant date and time')) +&#10;       SIZEOF (QUERY (ada &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'APPLIED_DATE_ASSIGNMENT.ITEMS') |&#10;       ada.role\date_role.name = 'participant date')) = 1"/>
<where label="WR3" expression="(NOT (SELF\action.name = 'rule justification')) OR&#10;       (SIZEOF (QUERY (ja &lt;* QUERY (ar &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'ACTION_RELATIONSHIP.RELATED_ACTION') |&#10;       ar\action_relationship.name = 'justified action') |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'RULE_ACTION' IN&#10;       TYPEOF (ja.relating_action))) = 1)"/>
<where label="WR4" expression="(NOT (SELF\action.name = 'rule modification')) OR&#10;       (SIZEOF (QUERY (mr &lt;* QUERY (ar &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'ACTION_RELATIONSHIP.RELATED_ACTION') |&#10;       ar\action_relationship.name = 'modification rationale') |&#10;       ('PRODUCTION_RULE_MIM.' +&#10;       'RULE_ACTION' IN&#10;       TYPEOF (mr.relating_action)) AND&#10;       (mr.relating_action\action.name = 'rule change request'))) = 1)"/>
</entity>
<entity name="rule_boolean_function_definition" supertypes="rule_function_definition">
<where label="WR1" expression="SIZEOF (QUERY (it &lt;* SELF.items |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'MODEL_PARAMETER' IN&#10;       TYPEOF (it))) &gt;= 1"/>
</entity>
<entity name="rule_complex_clause" supertypes="representation">
<unique label="UR1">
<unique.attribute entity-ref="representation" attribute="name"/>
</unique>
<where label="WR1" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' + &#10;       'REPRESENTATION_RELATIONSHIP.REP_2') | &#10;       'PRODUCTION_RULE_MIM.' +&#10;       'RULE_SIMPLE_CLAUSE' IN TYPEOF (rr.rep_1))) &gt;= 1"/>
<where label="WR2" expression="SIZEOF(TYPEOF(SELF) - TYPEOF(SELF\representation ||&#10;       SELF\rule_complex_clause)) = 0"/>
</entity>
<entity name="rule_conclusion_definition" supertypes="representation">
<where label="WR1" expression="SIZEOF (QUERY (pdr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'PROPERTY_DEFINITION_REPRESENTATION.USED_REPRESENTATION') |&#10;        'PRODUCTION_RULE_MIM.' +&#10;        'RULE_DEFINITION' IN TYPEOF&#10;       (pdr.definition.definition))) = 1"/>
<where label="WR2" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION_RELATIONSHIP.REP_2') |&#10;        'PRODUCTION_RULE_MIM.' +&#10;        'RULE_SIMPLE_CLAUSE' IN TYPEOF &#10;       (rr\representation_relationship.rep_1))) &gt;= 1"/>
<where label="WR3" expression="SIZEOF(TYPEOF(SELF) - TYPEOF(SELF\representation ||&#10;       SELF\rule_conclusion_definition)) = 0"/>
</entity>
<entity name="rule_definition" supertypes="rule_software_definition">
<where label="WR1" expression="SELF\product_definition.formation.description = 'rule version'"/>
</entity>
<entity name="rule_function_definition" supertypes="representation" super.expression="rule_boolean_function_definition">
<where label="WR1" expression="SIZEOF (QUERY (it &lt;* SELF.items |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'MODEL_PARAMETER' IN&#10;       TYPEOF (it))) &gt;= 1"/>
<where label="WR2" expression="SIZEOF(QUERY(adf &lt;* USEDIN(SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'APPLIED_DOCUMENT_REFERENCE.ITEMS') |&#10;       (adf\document_reference.assigned_document.kind\document_type.product_data_type&#10;       = 'reference document') AND&#10;       (SIZEOF(['PRODUCTION_RULE_MIM.' +&#10;       'SPECIFICATION_DEFINITION', &#10;       'PRODUCTION_RULE_MIM.' +&#10;       'DOCUMENT'] * &#10;        TYPEOF(adf\document_reference.assigned_document))&gt;=1))) = 1"/>
<where label="WR3" expression="SIZEOF(QUERY(adf &lt;* USEDIN(SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'APPLIED_DOCUMENT_REFERENCE.ITEMS') |&#10;       (adf\document_reference.assigned_document.kind\document_type.product_data_type =&#10;       'source code') AND&#10;       ('PRODUCTION_RULE_MIM.' +&#10;       'SPECIFICATION_DEFINITION' IN &#10;        TYPEOF(adf\document_reference.assigned_document)))) = 1"/>
</entity>
<entity name="rule_function_domain_parameter" supertypes="model_parameter">
<where label="WR1" expression="SIZEOF (QUERY (cri &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION.ITEMS') |&#10;       ('PRODUCTION_RULE_MIM.' +&#10;       'RULE_FUNCTION_DEFINITION' IN TYPEOF(cri)) &#10;       )) = 1"/>
</entity>
<entity name="rule_function_range_parameter" supertypes="model_parameter">
<where label="WR1" expression="SIZEOF (QUERY (cri &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION.ITEMS') |&#10;       ('PRODUCTION_RULE_MIM.' +&#10;       'RULE_FUNCTION_DEFINITION' IN TYPEOF(cri)) &#10;       )) = 1"/>
</entity>
<entity name="rule_general_clause" supertypes="representation">
<unique label="UR1">
<unique.attribute entity-ref="representation" attribute="name"/>
</unique>
<where label="WR1" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION_RELATIONSHIP.REP_1') |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'PARAMETER_ASSIGNMENT_REPRESENTATION' IN&#10;       TYPEOF (rr.rep_2))) &gt;= 1"/>
<where label="WR2" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' + &#10;       'REPRESENTATION_RELATIONSHIP.REP_2') | &#10;       'PRODUCTION_RULE_MIM.' +&#10;       'RULE_FUNCTION_DEFINITION' IN TYPEOF (rr.rep_1))) = 1"/>
<where label="WR3" expression="SIZEOF(TYPEOF(SELF) - TYPEOF(SELF\representation ||&#10;       SELF\rule_general_clause)) = 0"/>
</entity>
<entity name="rule_premise_definition" supertypes="representation">
<where label="WR1" expression="SIZEOF (QUERY (pdr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'PROPERTY_DEFINITION_REPRESENTATION.USED_REPRESENTATION') |&#10;        'PRODUCTION_RULE_MIM.' +&#10;        'RULE_DEFINITION' IN TYPEOF&#10;       (pdr.definition.definition))) = 1"/>
<where label="WR2" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION_RELATIONSHIP.REP_2') |&#10;        'PRODUCTION_RULE_MIM.' +&#10;        'RULE_COMPLEX_CLAUSE' IN TYPEOF &#10;       (rr\representation_relationship.rep_1))) &gt;= 1"/>
<where label="WR3" expression="SIZEOF(TYPEOF(SELF) - TYPEOF(SELF\representation ||&#10;       SELF\rule_premise_definition)) = 0"/>
</entity>
<entity name="rule_set" supertypes="rule_software_definition"/>
<entity name="rule_set_group" supertypes="rule_software_definition">
<where label="WR1" expression="SIZEOF (QUERY (rsge &lt;* QUERY (gr &lt;* USEDIN (SELF, &#10;       'PRODUCTION_RULE_MIM.' + &#10;       'PRODUCT_DEFINITION_RELATIONSHIP.RELATING_PRODUCT_DEFINITION') |&#10;       gr\product_definition_relationship.name = 'rule set group element') |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'RULE_SET' IN&#10;       TYPEOF (rsge.related_product_definition))) &gt;= 1"/>
</entity>
<entity name="rule_simple_clause" supertypes="representation">
<unique label="UR1">
<unique.attribute entity-ref="representation" attribute="name"/>
</unique>
<where label="WR1" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'REPRESENTATION_RELATIONSHIP.REP_1') |&#10;       'PRODUCTION_RULE_MIM.' +&#10;       'PARAMETER_ASSIGNMENT_REPRESENTATION' IN&#10;       TYPEOF (rr.rep_2))) &gt;= 1"/>
<where label="WR2" expression="SIZEOF (QUERY (rr &lt;* USEDIN (SELF,&#10;       'PRODUCTION_RULE_MIM.' + &#10;       'REPRESENTATION_RELATIONSHIP.REP_2') | &#10;       'PRODUCTION_RULE_MIM.' +&#10;       'RULE_BOOLEAN_FUNCTION_DEFINITION' IN TYPEOF (rr.rep_1))) = 1"/>
<where label="WR3" expression="SIZEOF(TYPEOF(SELF) - TYPEOF(SELF\representation ||&#10;       SELF\rule_simple_clause)) = 0"/>
</entity>
<entity name="rule_software_definition" supertypes="product_definition"/>
<entity name="rule_superseded_assignment" supertypes="action_assignment">
<explicit name="items">
<aggregate type="SET" lower="1" upper="?"/>
<typename name="rule_superseded_item"/>
</explicit>
</entity>
<entity name="rule_supersedence" supertypes="rule_action"/>
<rule name="rule_action_unique_constraint" appliesto="rule_action">
<algorithm>LOCAL
  adta : BAG OF applied_date_and_time_assignment;
  adta_bag : BAG OF applied_date_and_time_assignment := [];
  ra_bag : BAG OF rule_action;
  aaa_bag : BAG OF applied_action_assignment;
  pass : BOOLEAN := TRUE;
  rd_bag : BAG OF product_definition_formation;
END_LOCAL;

REPEAT i := 1 to SIZEOF(rule_action) by 1;
  adta := USEDIN( rule_action[i], 
'PRODUCTION_RULE_MIM.' +
'APPLIED_DATE_AND_TIME_ASSIGNMENT.ITEMS' );
  REPEAT j := 1 to SIZEOF(adta) by 1;
    IF EXISTS( adta[j] ) THEN
      IF( NOT( adta[j] IN adta_bag ) ) THEN
        adta_bag := adta_bag + adta[j];
      END_IF;
    END_IF;
  END_REPEAT;
END_REPEAT;

REPEAT i := 1 to SIZEOF(adta_bag) by 1;
  IF ( NOT pass ) THEN ESCAPE;
  END_IF;
  ra_bag := QUERY( r &lt;* rule_action | (r IN adta_bag[i].items) );
  rd_bag := [];
  REPEAT j := 1 to SIZEOF(ra_bag) by 1;
    IF ( NOT pass ) THEN ESCAPE;
    END_IF;
    aaa_bag := QUERY( aa &lt;* USEDIN( ra_bag[j], 
'PRODUCTION_RULE_MIM.' +
'ACTION_ASSIGNMENT.ASSIGNED_ACTION' ) | 
(('PRODUCTION_RULE_MIM.' +
'APPLIED_ACTION_ASSIGNMENT') IN TYPEOF(aa) ) );
    REPEAT k := 1 to SIZEOF(aaa_bag) by 1;
      IF ( NOT pass ) THEN ESCAPE;
      END_IF;
      REPEAT l := 1 to SIZEOF(aaa_bag[k].items) by 1;
        IF EXISTS( aaa_bag[k].items[l] ) THEN
          IF ( ('PRODUCTION_RULE_MIM.' +
'PRODUCT_DEFINITION_FORMATION'  IN TYPEOF(aaa_bag[k].items[l])) AND
(aaa_bag[k].items[l]\product_definition_formation.description = 'rule version') ) THEN
            IF ( aaa_bag[k].items[l] IN rd_bag ) THEN
              pass := FALSE;
              ESCAPE;
            ELSE
              rd_bag := rd_bag + aaa_bag[k].items[l];
            END_IF;
          END_IF;
        END_IF;
      END_REPEAT;
    END_REPEAT;
  END_REPEAT;
END_REPEAT;</algorithm>
<where label="WR1" expression="pass"/>
</rule>
<rule name="rule_conclusion_definition_unique_constraint" appliesto="rule_conclusion_definition representation representation_relationship">
<algorithm>LOCAL
r : BAG of representation := 
           QUERY (r &lt;* representation | r\representation.name = 
                                             'rule definition');
rr : BAG OF representation_relationship := [];
pass : BOOLEAN := TRUE;
count : INTEGER := 0;
name_bag : BAG OF string := [];
END_LOCAL;
  REPEAT i := 1 to SIZEOF (r) by 1;
   count := 0;
   name_bag := [];
   IF NOT pass THEN ESCAPE;
   END_IF;
   rr := USEDIN(r[i],
 'PRODUCTION_RULE_MIM.' +
        'REPRESENTATION_RELATIONSHIP.REP_1');
   REPEAT j := 1 to SIZEOF (rr) by 1;
    IF 'PRODUCTION_RULE_MIM.' +
       'RULE_CONCLUSION_DEFINITION' IN
       TYPEOF (rr[j].rep_2)
    THEN
      IF EXISTS( rr[j].rep_2\representation.name ) THEN
        IF rr[j].rep_2\representation.name IN name_bag
        THEN
         pass := FALSE;
        ELSE
         name_bag := name_bag + rr[j].rep_2\representation.name;
        END_IF;
      END_IF;
    END_IF;
   END_REPEAT;
  END_REPEAT;</algorithm>
<where label="WR1" expression="pass"/>
</rule>
<rule name="rule_function_unique_constraint" appliesto="rule_function_definition">
<algorithm>LOCAL
  name_bag : BAG OF STRING := [];
  rfd_bag : BAG OF rule_function_definition;
  adr_bag : BAG OF applied_document_reference;
  pass : BOOLEAN := TRUE;
  doc_bag : BAG OF document;
END_LOCAL;

REPEAT i := 1 to SIZEOF(rule_function_definition) by 1;
  IF EXISTS( rule_function_definition[i]\representation.name ) THEN
    IF( NOT( rule_function_definition[i]\representation.name IN name_bag ) ) THEN
      name_bag := name_bag + rule_function_definition[i]\representation.name;
    END_IF;
  END_IF;
END_REPEAT;

REPEAT i := 1 to SIZEOF(name_bag) by 1;
  IF ( NOT pass ) THEN ESCAPE;
  END_IF;
  doc_bag := [];
  rfd_bag := QUERY( am &lt;* rule_function_definition | 
               (am\representation.name = name_bag[i]) );
  REPEAT j := 1 to SIZEOF(rfd_bag) by 1;
    IF ( NOT pass ) THEN ESCAPE;
    END_IF;
    adr_bag := QUERY( adr &lt;* USEDIN( rfd_bag[j],
'PRODUCTION_RULE_MIM.'
+ 'APPLIED_DOCUMENT_REFERENCE.ITEMS' ) |
(adr.assigned_document.kind\document_type.product_data_type = 'reference document') );
    REPEAT k := 1 to SIZEOF(adr_bag) by 1;
      IF EXISTS( adr_bag[k].assigned_document ) THEN
        IF ( adr_bag[k].assigned_document IN doc_bag ) THEN
          pass := FALSE;
          ESCAPE;
        ELSE
          doc_bag := doc_bag + adr_bag[k].assigned_document;
        END_IF;
      END_IF;
    END_REPEAT;
  END_REPEAT;
END_REPEAT;</algorithm>
<where label="WR1" expression="pass"/>
</rule>
<rule name="rule_premise_definition_unique_constraint" appliesto="rule_premise_definition representation representation_relationship">
<algorithm>local
rr : BAG OF representation_relationship := [];
rpd : BAG OF rule_premise_definition := [];
pass : BOOLEAN := TRUE;
count : INTEGER := 0;
END_LOCAL;
  REPEAT i := 1 to SIZEOF (rule_premise_definition) by 1;
   count := 0;
   IF NOT pass THEN ESCAPE;
   END_IF;
   rr :=
USEDIN(rule_premise_definition[i],'REPRESENTATION_SCHEMA.REPRESENTATION_RELATIONSHIP.REP_2');
    REPEAT j := 1 to SIZEOF (rr) by 1;
     IF NOT pass THEN ESCAPE;
     END_IF;
     IF (rr[j]\representation_relationship.rep_1\representation.description IN
              ['rule definition']) THEN
     count := count + 1;
     END_IF;
     IF count = 2 THEN pass := FALSE;
     END_IF;
    END_REPEAT;
  END_REPEAT;</algorithm>
<where label="WR1" expression="pass"/>
</rule>
</schema>
</express>
