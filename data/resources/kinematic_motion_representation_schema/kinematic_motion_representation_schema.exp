(*
ISO TC184/SC4/WG12 N7302 - ISO/IS 10303-105 Kinematics - EXPRESS
*)

SCHEMA kinematic_motion_representation_schema;

REFERENCE FROM geometry_schema
    (axis2_placement,
     placement,
     cartesian_point,
     curve,
     geometric_representation_context,
     geometric_representation_item);

REFERENCE FROM measure_schema
    (length_measure,
     measure_with_unit,
     parameter_value,
     plane_angle_measure,
     unit);

REFERENCE FROM representation_schema
    (founded_item,
     functionally_defined_transformation,
     item_defined_transformation,
     item_in_context,
     representation,
     representation_item,
     representation_relationship,
     definitional_representation_relationship,
     representation_relationship_with_transformation,
     using_representations);
     
REFERENCE FROM kinematic_structure_schema
	(kinematic_link_representation,
	 rigid_placement);     

REFERENCE FROM kinematic_state_schema
    (rotation_about_direction,
     spatial_rotation,
     ypr_rotation,
     mechanism_state_representation);


REFERENCE FROM product_property_representation_schema
    (shape_representation);     

TYPE link_or_shape_representation = SELECT(
  kinematic_link_representation,
  shape_representation);
END_TYPE;

TYPE interpolation_type = ENUMERATION OF
  (undefined,
   discontinuous,
   synchronous,
   linear);
END_TYPE;

ENTITY interpolated_configuration_representation
  SUBTYPE OF (representation);
  SELF\representation.context_of_items : geometric_representation_context_with_parameter;
  SELF\representation.items : SET[1:1] OF interpolated_configuration_sequence;
END_ENTITY;

ENTITY interpolated_configuration_sequence
  SUBTYPE OF (representation_item);
  segments : LIST[1:?] OF interpolated_configuration_segment;
DERIVE
  n_segments : INTEGER := SIZEOF(segments);
  closed_interpoltation : LOGICAL := segments[n_segments].interpolation <> discontinuous;
END_ENTITY;  

ENTITY interpolated_configuration_segment
  SUBTYPE OF (founded_item);
  state : mechanism_state_representation;
  t_parameter : parameter_value;
  interpolation : interpolation_type;
END_ENTITY;

ENTITY link_motion_relationship
  SUBTYPE OF (representation_relationship_with_transformation, definitional_representation_relationship);
  SELF\representation_relationship.rep_1 : link_or_shape_representation;
  SELF\representation_relationship.rep_2 : link_motion_representation_along_path;
  SELF\representation_relationship_with_transformation.transformation_operator : link_motion_transformation;
WHERE
  WR1: rep_1 IN using_representations(transformation_operator\item_defined_transformation.transform_item_1);
  WR2: item_in_context(transformation_operator\item_defined_transformation.transform_item_2, rep_2);
END_ENTITY;

ENTITY link_motion_transformation
  SUBTYPE OF (item_defined_transformation);
  SELF\item_defined_transformation.transform_item_1 : rigid_placement;
  SELF\item_defined_transformation.transform_item_2 : kinematic_path;
END_ENTITY;

ENTITY link_motion_representation_along_path
  SUBTYPE OF (representation);
  SELF\representation.items : SET [1:?] OF kinematic_path;
  SELF\representation.context_of_items : geometric_representation_context_with_parameter;
END_ENTITY;

ENTITY geometric_representation_context_with_parameter 
  SUBTYPE OF (geometric_representation_context);
  parameter_unit : OPTIONAL unit;
END_ENTITY;

ENTITY translation
  SUBTYPE OF (geometric_representation_item);
  offset : LIST [2:3] OF length_measure;
END_ENTITY;

ENTITY transform
  SUBTYPE OF (functionally_defined_transformation, geometric_representation_item);
  rotation_component    : spatial_rotation;
  translation_component : translation;
END_ENTITY;

ENTITY path_node
  SUBTYPE OF (geometric_representation_item);
  control_transform : transform_or_placement;
  t_parameter       : parameter_value;
END_ENTITY;

TYPE transform_or_placement = SELECT (transform, axis2_placement);
END_TYPE;

ENTITY kinematic_path
  SUPERTYPE OF (ONEOF (path_element, composite_path))
  SUBTYPE OF (geometric_representation_item);
WHERE
  WR1: SIZEOF(QUERY(using_rep <* using_representations(SELF)| 
        NOT('KINEMATIC_MOTION_REPRESENTATION_SCHEMA.GEOMETRIC_REPRESENTATION_CONTEXT_WITHPARAMETER' IN TYPEOF(using_rep.context_of_items))))= 0;
END_ENTITY;

ENTITY path_element_connection
  SUBTYPE OF (founded_item);
  previous_element     : path_element;
  next_element         : path_element;
WHERE
  WR1: previous_element.node_to = next_element.node_from;
END_ENTITY;

ENTITY composite_path
  SUBTYPE OF (kinematic_path);
  elements : SET [1:?] OF path_element_connection;
  t_start : parameter_value;
  t_end : parameter_value;
WHERE
  WR1: t_start < t_end;
  WR2: connected_in_simple_path (elements);
END_ENTITY;

ENTITY path_element
  SUPERTYPE OF (ONEOF (point_to_point_path,
                       circular_path,
                       linear_path,
                       curve_based_path))
  SUBTYPE OF (kinematic_path);
  node_from : path_node;
  node_to   : path_node;
WHERE
  WR1: node_from.t_parameter < node_to.t_parameter;
END_ENTITY;

ENTITY point_to_point_path
  SUBTYPE OF (path_element);
END_ENTITY;

ENTITY circular_path
  SUBTYPE OF (path_element);
  via_point : cartesian_point;
WHERE
  WR1: SELF\path_element.node_to.control_transform.translation_component <>
       SELF\path_element.node_from.control_transform.translation_component;
(*  
  WR2: non_coincident_coordinates (via_point,
         SELF\path_element.node_from.control_transform.translation_component)
       AND
       non_coincident_coordinates (via_point,
         SELF\path_element.node_to.control_transform.translation_component);
*)         
END_ENTITY;

ENTITY linear_path
  SUBTYPE OF (path_element);
END_ENTITY;

ENTITY curve_based_path
  SUBTYPE OF (path_element);
  path_curve : curve;
WHERE
  WR1: SELF\path_element.node_to.control_transform.translation_component <>
       SELF\path_element.node_from.control_transform.translation_component;
END_ENTITY;

FUNCTION connected_in_simple_path (connections : SET OF path_element_connection)
                                               : BOOLEAN;
  LOCAL
     connection_set : SET [0 : ?] OF path_element_connection;
     nec0           : INTEGER;
     pec0           : INTEGER;
     necbranch      : INTEGER;
     pecbranch      : INTEGER;
  END_LOCAL;

  IF SIZEOF (connections) > 1 THEN
    connection_set := QUERY (pec1 <* connections |
                        SIZEOF (QUERY (pec2 <* connections - pec1 |
                          pec1.next_element :=: pec2.previous_element)) = 0);
    nec0 := SIZEOF (connection_set);

    connection_set := QUERY (pec1 <* connections |
                        SIZEOF (QUERY (pec2 <* connections - pec1 |
                          pec2.next_element :=: pec1.previous_element)) = 0);
    pec0 := SIZEOF (connection_set);

    connection_set := QUERY (pec1 <* connections |
                        SIZEOF (QUERY (pec2 <* connections - pec1 |
                          pec1.next_element :=: pec2.previous_element)) > 1);
    necbranch := SIZEOF (connection_set);

    connection_set := QUERY (pec1 <* connections |
                        SIZEOF (QUERY (pec2 <* connections - pec1 |
                          pec2.next_element :=: pec1.previous_element)) > 1);
    pecbranch := SIZEOF (connection_set);

    IF ((nec0 <> 1) OR (pec0 <> 1) OR (necbranch > 0) OR (pecbranch > 0)) THEN
      RETURN (FALSE);
    ELSE
      RETURN (TRUE);
    END_IF;
  ELSE
    RETURN (TRUE);
  END_IF;
END_FUNCTION;

(*
FUNCTION non_coincident_coordinates (crtpt : cartesian_point;
                                     trltn : translation) : BOOLEAN;
  IF ((crtpt.coordinates[1] = trltn.x) AND
      (crtpt.coordinates[2] = trltn.y) AND
      (crtpt.coordinates[3] = trltn.z)) THEN
    RETURN (FALSE);
  ELSE
    RETURN (TRUE);
  END_IF;
END_FUNCTION;
*)

SUBTYPE_CONSTRAINT kmr_representation_subtypes FOR representation;
  ONEOF (interpolated_configuration_representation, link_motion_representation_along_path);
END_SUBTYPE_CONSTRAINT; 

SUBTYPE_CONSTRAINT kmr_geometric_representation_item_subtypes FOR geometric_representation_item;
  ONEOF (
    kinematic_path,
    path_node,
    placement,
    transform,
    translation
  );
END_SUBTYPE_CONSTRAINT; 

END_SCHEMA;   -- end kinematic_motion_representation_schema
